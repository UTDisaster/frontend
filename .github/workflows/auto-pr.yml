name: Auto open PR to main

on:
  push:
    branches:
      - "issue-*"

permissions:
  contents: read
  pull-requests: write

jobs:
  open-pr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Show debug info
        run: |
          echo "ref_name=${GITHUB_REF_NAME}"
          echo "sha=${GITHUB_SHA}"
          echo "head message (from git):"
          git log -1 --pretty=%B

      - name: Check magic word in HEAD commit message
        id: magic
        shell: bash
        run: |
          msg="$(git log -1 --pretty=%B)"
          if echo "$msg" | grep -Eiq '\b(complete|completed|fix|fixes|fixed|resolve|resolves|resolved)\b'; then
            echo "hit=true" >> "$GITHUB_OUTPUT"
          else
            echo "hit=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Stop if no magic word
        if: steps.magic.outputs.hit != 'true'
        run: exit 0

      - name: Extract issue number from branch name
        id: issue
        shell: bash
        run: |
          br="${GITHUB_REF_NAME}"
          issue="$(echo "$br" | grep -Eo '[0-9]+' | head -n1 || true)"
          echo "number=$issue" >> "$GITHUB_OUTPUT"

      - name: Create or update PR via GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          base="main"
          head_branch="${GITHUB_REF_NAME}"
          head_owner="${GITHUB_REPOSITORY_OWNER}"
          head="${head_owner}:${head_branch}"

          title="Merge ${head_branch} -> ${base}"
          if [ -n "${{ steps.issue.outputs.number }}" ]; then
            body=$'Fixes #'"${{ steps.issue.outputs.number }}"$'\n\nAuto-opened from branch `'"${head_branch}"$'`.'
          else
            body="Auto-opened from branch \`${head_branch}\`."
          fi

          # Find existing PR by head/base
          pr_url="$(gh pr list --state open --head "$head" --base "$base" --json url -q '.[0].url' || true)"

          if [ -n "$pr_url" ]; then
            echo "PR already exists: $pr_url; updating title/body."
            gh pr edit "$pr_url" --title "$title" --body "$body"
            exit 0
          fi

          # Create, but treat "already exists" as success (race-proof)
          if ! gh pr create --base "$base" --head "$head_branch" --title "$title" --body "$body" 2>err.txt; then
            if grep -qi "already exists" err.txt; then
              echo "PR already exists (race); check satisfied."
              exit 0
            fi
            cat err.txt >&2
            exit 1
          fi
