name: Auto open PR to master

on:
  push:
    branches:
      - "issue-*"

permissions:
  contents: read
  pull-requests: write

jobs:
  open-pr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Show debug info
        run: |
          echo "ref_name=${GITHUB_REF_NAME}"
          echo "sha=${GITHUB_SHA}"
          echo "head message (from git):"
          git log -1 --pretty=%B

      - name: Check magic word in HEAD commit message
        id: magic
        shell: bash
        run: |
          msg="$(git log -1 --pretty=%B)"
          if echo "$msg" | grep -Eiq '\b(complete|completed|fix|fixes|fixed|resolve|resolves|resolved)\b'; then
            echo "hit=true" >> "$GITHUB_OUTPUT"
          else
            echo "hit=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Stop if no magic word
        if: steps.magic.outputs.hit != 'true'
        run: exit 0

      - name: Extract issue number from branch name
        id: issue
        shell: bash
        run: |
          br="${GITHUB_REF_NAME}"
          issue="$(echo "$br" | grep -Eo '[0-9]+' | head -n1 || true)"
          echo "number=$issue" >> "$GITHUB_OUTPUT"

      - name: Create PR via GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          head="${GITHUB_REF_NAME}"
          base="master"

          title="Merge ${head} -> ${base}"
          if [ -n "${{ steps.issue.outputs.number }}" ]; then
            body=$'Fixes #'"${{ steps.issue.outputs.number }}"$'\n\nAuto-opened from branch `'"${head}"$'`.'
          else
            body="Auto-opened from branch \`${head}\`."
          fi

          if url="$(gh pr view --head "$head" --base "$base" --json url -q .url 2>/dev/null)"; then
            echo "PR already exists: $url; updating title/body."
            gh pr edit "$url" --title "$title" --body "$body"
            exit 0
          fi

          gh pr create --base "$base" --head "$head" --title "$title" --body "$body"
